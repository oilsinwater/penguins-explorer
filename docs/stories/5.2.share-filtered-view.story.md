# Story 5.2: Share Filtered View

## Status

Draft

## Story

**As a** user,
**I want** to share my filtered view,
**so that** I can collaborate with colleagues using specific data views.

_Part of Epic 5: Data Export & Sharing (docs/prd/user-stories-acceptance-criteria.md)._

## Acceptance Criteria

1. URL structure: /visualize/[chartType]?[filters] (e.g., /visualize/scatter?x=bill_length&y=body_mass)
2. Copy URL button with confirmation
3. Loading shared URL restores exact state
4. Social sharing preview metadata

## Dev Notes

### Previous Story Insights

- Story 5.1 introduced export functionality with canvas rendering and filename generation; the `ShareButton` component already exists alongside `ExportButton` in the visualization panel, but its URL-sharing logic needs to be fully implemented. [Source: docs/stories/5.1.save-visualizations.story.md]
- The `useURLSync` hook handles bidirectional URL state synchronization with 100ms debouncing, providing the foundation for shareable links. [Source: docs/stories/5.1.save-visualizations.story.md]

### Data Models

- No specific data models required; this feature relies on existing Penguin and Filter types for state serialization. [Source: architecture/state-management.md]

### API Specifications

- No backend API required; URL sharing is entirely client-side using browser location APIs and the existing filter/chart state serialization methods. [Source: architecture/routing.md]

### Component Specifications

- `ShareButton` component already exists in `src/components/export/` and is rendered in visualization routes alongside `ExportButton`; enhance it to copy the current URL and provide user feedback. [Source: architecture/component-architecture.md#sharebutton]
- URL parameter schema includes filters (species, island, sex) and chart configuration (x, y, field, bins, color) persisted via `useURLSync`. [Source: architecture/routing.md#url-parameter-schema]
- `useURLSync` hook implements bidirectional URL state synchronization with debounced navigation (100ms) to prevent excessive history entries. [Source: architecture/routing.md#url-synchronization-hook]

### File Locations

- Export/share UI lives in `src/components/export/` (`ShareButton.tsx`, `ExportButton.tsx`). [Source: architecture/source-tree.md#project-organization]
- URL state management hooks reside in `src/hooks/` (`useURLSync.ts`). [Source: architecture/source-tree.md#hook-organization]
- URL parameter utilities are located in `src/utils/urlHelpers.ts` for serialization/validation logic. [Source: architecture/source-tree.md#utility-organization]
- Social preview metadata should be added to `public/` directory as Open Graph images (e.g., `social-preview.png`). [Source: architecture/source-tree.md#project-organization]

### Testing Requirements

- Follow the testing pyramid: Vitest/RTL for component and hook unit tests, Cypress for E2E URL sharing flows. [Source: architecture/testing-strategy.md#pyramid-distribution]
- Unit tests in `tests/unit/components/export/` for ShareButton interaction and clipboard operations. [Source: architecture/testing-strategy.md#file-locations]
- Integration tests in `tests/integration/` for URL state restoration across different filter/chart combinations. [Source: architecture/testing-strategy.md#file-locations]
- E2E tests in `cypress/e2e/` validating full URL sharing workflow: copy → paste → state restoration. [Source: architecture/testing-strategy.md#file-locations]
- Accessibility validation using axe-core to ensure share button meets WCAG 2.1 AA compliance. [Source: architecture/testing-strategy.md#validation-requirements]

### Technical Constraints

- URL synchronization uses debounced navigation (100ms) via `useURLSync` to prevent excessive browser history entries during rapid filter changes. [Source: architecture/routing.md#url-synchronization-hook]
- URL parameters are validated and normalized using `validateAndNormalizeURL` to handle malformed or invalid query strings gracefully. [Source: architecture/routing.md#deep-linking-support]
- Clipboard API requires HTTPS in production; provide fallback for local development using `document.execCommand('copy')` if necessary. [Source: architecture/tech-stack.md]
- Social preview metadata requires Open Graph meta tags in `index.html` with absolute URLs for preview images (e.g., `og:image`, `og:url`, `og:title`). [Source: architecture/source-tree.md]
- FilterStore and URL state must remain synchronized bidirectionally: user actions update URL, and URL changes (browser back/forward, direct link) update filters. [Source: architecture/state-management.md#url-state-synchronization]

## Project Structure Notes

- ShareButton lives in `src/components/export/` alongside ExportButton, maintaining consistency with the export feature set. [Source: architecture/source-tree.md#project-organization]
- URL helpers for serialization/validation belong in `src/utils/urlHelpers.ts` to centralize URL management logic. [Source: architecture/source-tree.md#utility-organization]
- Social preview images are static assets in `public/` directory, served at the root path for external link crawlers. [Source: architecture/source-tree.md#project-organization]

## Tasks / Subtasks

- [ ] **Task 1: Enhance ShareButton component with clipboard functionality** (AC: 2)
  - [ ] Implement `navigator.clipboard.writeText()` to copy the current URL when the button is clicked. [Source: architecture/component-architecture.md#sharebutton]
  - [ ] Add user feedback (e.g., toast notification or button label change) confirming successful copy operation. [Source: architecture/coding-standards.md]
  - [ ] Include fallback for browsers without Clipboard API support using `document.execCommand('copy')`. [Source: architecture/tech-stack.md]
  - [ ] Write unit tests for ShareButton in `tests/unit/components/export/ShareButton.test.tsx` covering click handlers and clipboard interactions. [Source: architecture/testing-strategy.md#file-locations]

- [ ] **Task 2: Verify URL state restoration logic** (AC: 1, 3)
  - [ ] Confirm `useURLSync` hook correctly hydrates filter and chart state from URL parameters on component mount or URL change. [Source: architecture/routing.md#url-synchronization-hook]
  - [ ] Validate that `validateAndNormalizeURL` sanitizes malformed parameters and provides sensible defaults. [Source: architecture/routing.md#deep-linking-support]
  - [ ] Test edge cases: missing parameters, invalid species/island/sex values, out-of-range bin counts. [Source: architecture/state-management.md#state-validation]
  - [ ] Write integration tests in `tests/integration/` verifying state restoration for various URL combinations. [Source: architecture/testing-strategy.md#file-locations]

- [ ] **Task 3: Add social sharing metadata** (AC: 4)
  - [ ] Insert Open Graph meta tags in `index.html` (or via React Helmet) with dynamic title, description, and image URL. [Source: architecture/source-tree.md#project-organization]
  - [ ] Create or reference `public/social-preview.png` for the `og:image` property; ensure it's an absolute URL for external crawlers. [Source: architecture/source-tree.md#project-organization]
  - [ ] Include Twitter Card meta tags for enhanced Twitter link previews (`twitter:card`, `twitter:title`, `twitter:image`). [Source: architecture/tech-stack.md]
  - [ ] Write a smoke test or manual validation checklist confirming link previews render correctly when shared on Slack, Twitter, or LinkedIn.

- [ ] **Task 4: Add regression and accessibility coverage** (AC: 1-4)
  - [ ] Write Cypress E2E test in `cypress/e2e/` for full URL sharing workflow: user adjusts filters/chart → clicks share button → copies URL → navigates to copied URL → verifies state matches. [Source: architecture/testing-strategy.md#file-locations]
  - [ ] Include axe-core assertions in Cypress tests to validate ShareButton accessibility (button role, aria-label, keyboard activation). [Source: architecture/testing-strategy.md#validation-requirements]
  - [ ] Verify WCAG 2.1 AA compliance for ShareButton focus indicators and contrast ratios. [Source: architecture/coding-standards.md]
  - [ ] Add unit tests for URL helper functions (`serializeToURL`, `hydrateFromURL`) in `tests/unit/utils/urlHelpers.test.ts`. [Source: architecture/testing-strategy.md#file-locations]

## Testing

### Test File Locations

- Unit tests: `tests/unit/components/export/ShareButton.test.tsx`, `tests/unit/utils/urlHelpers.test.ts`
- Integration tests: `tests/integration/url-state-restoration.test.tsx`
- E2E tests: `cypress/e2e/user-flows/share-filtered-view.cy.ts`

### Testing Frameworks and Patterns

- Vitest + React Testing Library for unit and integration tests
- Cypress for end-to-end user flow validation
- axe-core for automated accessibility compliance checks

### Specific Testing Requirements

- **Unit Tests**: Verify ShareButton click handler calls `navigator.clipboard.writeText()` with correct URL; mock Clipboard API and assert feedback UI updates.
- **Integration Tests**: Test URL state restoration across multiple filter/chart configurations (scatter, histogram, box plot with varying filters).
- **E2E Tests**: Full workflow from filter selection → chart configuration → share button click → URL copy → new browser tab → state verification.
- **Accessibility Tests**: Ensure ShareButton has proper ARIA attributes, keyboard activation works, and focus indicators meet WCAG standards.
- **Coverage Target**: 85% line coverage for ShareButton component and URL utility functions. [Source: architecture/testing-strategy.md#validation-requirements]

## Change Log

| Date       | Version | Description                                      | Author |
| ---------- | ------- | ------------------------------------------------ | ------ |
| 2025-10-06 | v0.1    | Initial draft for story 5.2 "Share Filtered View" | Bob    |
