# Test Design: Story 3.2 - See Distributions with Histograms

**Story File**: docs/stories/3.2.see-distributions-with-histograms.story.md
**Date**: 2025-09-13
**Author**: Quinn (Test Architect)
**Version**: 1.0

## Overview

This test design covers comprehensive test scenarios for implementing overlapping histogram visualizations for penguin measurement distributions. Tests trace to all 7 acceptance criteria (ACs) using Given-When-Then (GWT) patterns. Coverage includes:

- **Unit Tests** (Vitest/RTL): Component rendering, props handling, D3 mocks.
- **Integration Tests** (Cypress Component): Component interactions in VisualizationPanel.
- **E2E Tests** (Cypress): Full user flows via /visualize/histogram route.
- **Accessibility Tests** (axe-core): ARIA compliance, keyboard navigation.
- **Visual/Regression Tests**: Snapshot comparisons for histogram rendering (using Vitest or Cypress).
- **Performance Tests**: Load time for bin calculations (manual or lighthouse).
- **Edge Cases**: Missing data, empty filters, extreme bin sizes.

Risk-based prioritization: High coverage for AC2 (overlapping distributions) and AC6 (responsive), as visual accuracy is core.

## Requirements Traceability Matrix

| AC # | Description                       | Test Coverage                                 |
| ---- | --------------------------------- | --------------------------------------------- |
| 1    | Variable dropdown selection       | Unit (controls), E2E (URL param)              |
| 2    | Overlapping species distributions | Visual regression, Integration (D3 rendering) |
| 3    | Bin size control (5/10/20)        | Unit (radio buttons), E2E (re-render)         |
| 4    | Y-axis count labeling             | Visual regression, Unit (D3 axis)             |
| 5    | Species color/pattern distinction | Accessibility (contrast), Visual regression   |
| 6    | Responsive sizing                 | E2E (viewport resizing), Visual regression    |
| 7    | Alt text for accessibility        | Accessibility (axe-core scan)                 |

## Test Scenarios

### 1. Unit Tests: HistogramControls Component

**Objective**: Validate controls for variable/bin selection (AC1, AC3).

- **GWT 1.1**: Given default state, When component renders, Then dropdown shows first numeric field (bill_length_mm), bin radio default to 10.
  - Test: Render with mock props; assert Select value and radio checked.
  - Framework: Vitest/RTL.

- **GWT 1.2**: Given user selects flipper_length_mm and 5 bins, When onConfigChange called, Then callback emits {variable: 'flipper_length_mm', bins: 5}.
  - Test: fireEvent on Select/Radio; assert callback args.
  - Edge: Invalid selection (mock error).

- **GWT 1.3**: Given no props, When renders, Then uses sensible defaults (variable: bill_length_mm, bins: 10).
  - Test: Render without props; assert defaults.

### 2. Unit Tests: Histogram Component

**Objective**: Validate D3 histogram rendering (AC2, AC4, AC5).

- **GWT 2.1**: Given 344 penguins, variable bill_length_mm, bins 10, When renders, Then SVG contains 3 species bars (overlapping), Y-axis max ~35 (Adelie count).
  - Test: Mock D3 (histogram layout, scaleLinear); assert SVG path elements and text for counts.
  - Mock: d3.histogram, d3.scaleLinear.

- **GWT 2.2**: Given filtered to Adelie only, When renders, Then single species bars, colors match MUI palette (e.g., #1976d2).
  - Test: Pass filtered data; assert fill color and no overlaps.

- **GWT 2.3**: Given body_mass_g with outliers, bins 20, When renders, Then bars show frequency distribution, no negative counts.
  - Test: Assert bar widths/heights; edge: empty bin (width 0).

- **GWT 2.4**: Given missing values in variable, When renders, Then filters them out (no NaN bins).
  - Test: Inject NaNs; assert bin counts exclude them.

### 3. Integration Tests: VisualizationPanel with Histogram

**Objective**: Validate end-to-end component integration (AC1-6).

- **GWT 3.1**: Given mounted VisualizationPanel with chartType 'histogram', When loads, Then renders HistogramControls and Histogram, parses URL ?variable=bill_depth_mm&bins=5.
  - Test: Mount with providers (AppProvider, TanStack); assert components present and config applied.
  - Framework: Cypress Component.

- **GWT 3.2**: Given user changes bin to 20, When config updates, Then Histogram re-renders with new bins, URL updates.
  - Test: Interact with radio; assert URL change and SVG update.

### 4. E2E Tests: User Flow

**Objective**: Validate full browser experience (All ACs).

- **GWT 4.1**: Given /visualize/histogram, When loads with default filters, Then page shows histogram of bill_length_mm (10 bins), species overlapping, Y-axis counts.
  - Test: cy.visit('/visualize/histogram'); assert SVG elements, axis text.
  - Framework: Cypress.

- **GWT 4.2**: Given filters to Chinstrap, change variable to flipper_length_mm, bins 5, When interacts, Then histogram updates instantly, URL reflects ?variable=flipper_length_mm&bins=5&species=Chinstrap.
  - Test: cy.get('[data-testid=species-checkbox]').check('Chinstrap'); cy.get('select').select('flipper_length_mm'); assert URL and visual update.

- **GWT 4.3**: Given mobile viewport (375x667), When resizes, Then histogram resizes responsively (no overflow, bars scale).
  - Test: cy.viewport(375,667); assert no horizontal scroll, SVG width ~300px.

- **GWT 4.4**: Given all filters clear, When navigates away and back, Then state persists via URL.
  - Test: cy.visit('/visualize/histogram?bins=20'); cy.go('back'); cy.visit('/visualize/histogram'); assert bins=20.

### 5. Accessibility Tests

**Objective**: Validate WCAG compliance (AC5, AC7).

- **GWT 5.1**: Given rendered histogram, When axe-core scans, Then no violations (contrast, ARIA).
  - Test: Mount and run axe.getViolations(); assert empty array.
  - Framework: Vitest with @axe-core/react.

- **GWT 5.2**: Given keyboard navigation, When tabs through controls, Then focuses on dropdown/radios, announces changes.
  - Test: RTL fireEvent.tab(); assert focus outline, screenreader text.

- **GWT 5.3**: Given screen reader, When histogram renders, Then alt text describes "Overlapping histogram of bill length by species: Adelie peaks at 35-40mm...".
  - Test: Assert aria-label on SVG.

### 6. Performance & Edge Cases

**Objective**: Validate NFRs and robustness.

- **GWT 6.1**: Given 344 records, bins 5, When renders, Then <500ms load time.
  - Test: Manual timing or Cypress perf; assert under threshold.

- **GWT 6.2**: Given no data (all filters exclude penguins), When renders, Then shows "No data available" message, no errors.
  - Test: Apply extreme filters; assert message, no crash.

- **GWT 6.3**: Given invalid URL param (bins=999), When loads, Then defaults to 10, no error.
  - Test: cy.visit('/visualize/histogram?bins=999'); assert bins=10.

## Test Data & Mocks

- **Mock Data**: Use mockPenguins from fixtures (344 records, vary distributions).
- **D3 Mocks**: Mock d3.histogram, scaleBand, scaleLinear for unit tests.
- **Providers**: Wrap in AppProvider for state, ThemeProvider for colors.

## Automation Coverage Target

- Code Coverage: 90%+ for new components.
- Scenario Coverage: 100% AC traceability.
- Run Commands: `npm run test:unit`, `npm run test:integration`, `npm run test:e2e`, `npm run test:a11y`.

## Risks & Mitigations

- **Risk**: D3 overlapping opacity issues → Mitigation: Visual regression tests with Percy.
- **Risk**: Bin calculation precision → Mitigation: Assert exact counts from known data.

This design ensures robust validation once implemented. Recommend executing post-development.
